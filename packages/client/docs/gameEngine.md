# Игровой движок

- [GameEngine](#gameengine)
- [GameObject](#gameobject)

## Базовые классы

### GameEngine

#### Общее описание

`GameEngine` — основной класс, отвечающий за управление игровым циклом, рендеринг, обновление объектов и проверку столкновений. Управляет состоянием игры (запуск, остановка, пауза, продолжение) и логикой обработки эффектов (например, начисление очков или получение урона).

#### Конструктор

```ts
constructor(props: {
  ctx: CanvasRenderingContext2D;
  onDamage: () => void;
  onScore: () => void;
})
```

#### Свойства

| Название | Описание                                        |
| -------- | ----------------------------------------------- |
| ctx      | Возвращает массив коллизий объекта.             |
| onDamage | Колбэк, вызываемый при получении урона игроком. |
| onScore  | Колбэк, вызываемый при получении очков.         |

#### Публичные методы

| Название                                     | Описание                                                                     |
| -------------------------------------------- | ---------------------------------------------------------------------------- |
| initGameObject(gameObject: GameObject): this | Добавляет объект на сцену.                                                   |
| init(): this                                 | Инициализирует движок. Пока заглушка.                                        |
| start(): void                                | Запускает игровой цикл. Если уже запущен — выводит предупреждение в консоль. |
| stop(): void                                 | Полностью останавливает игровой цикл.                                        |
| pause(): void                                | Приостанавливает игровой цикл.                                               |
| resume(): void                               | Возобновляет игровой цикл после паузы.                                       |
| clearAndRenderEmpty(): this                  | Очищает канвас и возвращает экземпляр движка.                                |
| removeAllSceneObjects(): this                | Удаляет все объекты сцены.                                                   |

#### Приватные методы

| Название                                         | Описание                                                                                                                       |
| ------------------------------------------------ | ------------------------------------------------------------------------------------------------------------------------------ |
| loop(): void                                     | Основной игровой цикл: обновление объектов, отрисовка и проверка столкновений.                                                 |
| updateGameSpeed(delta: number): void             | Обновляет скорость игры с определённой периодичностью, согласно настройкам.                                                    |
| clearScene(): void                               | Полностью очищает канвас.                                                                                                      |
| checkCollisions(): void                          | Проверяет столкновения между игроком и другими объектами. В зависимости от `effectType` вызывает `onScore()` или `onDamage()`. |
| isColliding(a: Collision, b: Collision): boolean | Проверяет пересечение двух объектов по их границам (AABB).                                                                     |
| renderBackground(): void                         | Заливает фон канваса цветом.                                                                                                   |

#### Используемые типы

- `GameObject`: Базовый класс для объектов сцены.
- `Player`: Представляет объект игрока.
- `Collision`: Определяет границы объекта для проверки столкновений.
- `ObjectEffectType`: Перечисление типов эффектов (`Score`, `Damage`).

#### Пример использования

```ts
const engine = new GameEngine({
  ctx: canvas.getContext('2d'),
  onDamage: () => console.log('Игрок получил урон!'),
  onScore: () => console.log('Игрок набрал очки!'),
});

engine.initGameObject(new Player()).initGameObject(new Enemy()).init().start();
```

#### Примечания

- `GameEngine` ожидает, что каждый `GameObject` реализует методы `update(deltaTime, speed)` и `render()`.
- Скорость игры увеличивается со временем, повышая сложность.
- Проверка столкновений реализована через оси, выровненные по границам (AABB).

---

### GameObject

#### Общее описание

`GameObject` — абстрактный базовый класс для игровых объектов, предназначенных для рендеринга и взаимодействия на Canvas. Предоставляет базовую реализацию для работы с коллизиями, спавном и сбросом состояния.

Наследники должны реализовать методы `update()` и `render()`.

#### Свойства

| Название                              | Описание                                                 |
| ------------------------------------- | -------------------------------------------------------- |
| ctx: CanvasRenderingContext2D         | Контекст канваса для отрисовки объектов.                 |
| \_collisions: Collision[]             | Массив текущих коллизий объекта.                         |
| nextSpawnX: number                    | Следующая координата по оси X для генерации объекта.     |
| abstract effectType: ObjectEffectType | Тип эффекта при столкновении (`Score`, `Damage` и т.д.). |

#### Геттеры

| Название                | Описание                            |
| ----------------------- | ----------------------------------- |
| collisions: Collision[] | Возвращает массив коллизий объекта. |

#### Публичные методы

| Название                                                | Описание                                                                      |
| ------------------------------------------------------- | ----------------------------------------------------------------------------- |
| reset(): this                                           | Сбрасывает внутреннее состояние объекта (коллизии и координату `nextSpawnX`). |
| abstract update(delta: number, gameSpeed: number): void | Обновляет состояние объекта. Должен быть реализован в наследниках.            |
| abstract render(): void                                 | Отрисовывает объект. Должен быть реализован в наследниках.                    |

#### Защищённые методы

| Название                                                                                   | Описание                                                                             |
| ------------------------------------------------------------------------------------------ | ------------------------------------------------------------------------------------ |
| createCollisions({ minDistanceX, maxDistanceX, callback }: GenerateCollisionsParams): void | Генерирует коллизию с случайным отступом по оси X и вызывает `callback(nextSpawnX)`. |
| shouldSpawnNewObject({ last, minDistanceX, canvasRight }): boolean                         | Определяет, необходимо ли создать новый объект                                       |
| updateCollisions({ minDistanceX, maxDistanceX, callback }: GenerateCollisionsParams): void | Обновляет массив коллизий и инициирует создание новой, если необходимо.              |
| addCollision(collision: Collision): void                                                   | Добавляет коллизию в массив `_collisions`.                                           |
| toCanvasCoords(collision: Collision): Collision                                            | Преобразует координату Y в координату канваса (инвертирует ось).                     |

#### Используемые типы

- `Collision`: Интерфейс с координатами и размерами объекта (`x`, `y`, `width`, `height`).
- `GenerateCollisionsParams`: Параметры для генерации коллизий, включая `minDistanceX`, `maxDistanceX` и `callback`.
- `ObjectEffectType`: Тип эффекта от объекта (очки, урон и т.д.).

#### Примечания

- Базовый класс не предназначен для непосредственного использования. Используйте наследование для создания конкретных игровых объектов.
- Все координаты рассчитываются с учётом инверсии оси Y (Canvas имеет начало координат в левом верхнем углу).
- Метод `toCanvasCoords` может быть полезен при рендеринге объектов в нижней части экрана.

#### Пример использования

```ts
class Bonus extends GameObject {
  effectType = ObjectEffectType.Score;

  update(delta: number, gameSpeed: number) {
    this._collisions.forEach((c) => (c.x -= gameSpeed * delta * 100));
  }

  render() {
    this.ctx.fillStyle = 'green';
    this._collisions.forEach((c) => {
      const { x, y, width, height } = this.toCanvasCoords(c);
      this.ctx.fillRect(x, y, width, height);
    });
  }
}
```
